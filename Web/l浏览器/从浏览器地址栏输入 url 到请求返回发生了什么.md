# 从浏览器地址栏输入 url 到请求返回发生了什么

### 1、URL解析

URL（Uniform Resource Locator），统一资源定位符，用于定位互联网上资源，俗称网址。

一个URL包括`协议，网络地址，资源路径`

协议：`最常用的比如HTTP（超文本传输协议）FTP（文件传输协议）`

网络地址：`可以是域名或者ip地址，包括端口号，如果没有默认为80`

如果是不合法的地址，会转给默认的搜索引擎,例如如果你正在使用chrome，可以在url输入框输入你想要搜索的内容，然后搜索引擎会根据关键字进行搜索。

### 2、DNS域名解析

在浏览器输入网址后，首先要经过域名解析，因为浏览器并不能直接通过域名找到对应的服务器，而是要通过 IP 地址。

1. IP 地址：IP 地址是指互联网协议地址

2. 什么是域名解析
   
   DNS 协议提供通过域名查找 IP 地址，或逆向从 IP 地址反查域名的服务。
   DNS 是一个网络服务器，我们的域名解析简单来说就是在 DNS 上记录一条信息记录。

3. 浏览器如何通过域名去查询 URL 对应的 IP 呢？
   
   DNS域名解析分为递归查询和迭代查询两种方式，现一般为迭代查询。

**DNS缓存** 

DNS存在着多级缓存，从离浏览器的距离排序的话，有以下几种: 浏览器缓存，系统缓存，路由器缓存，IPS服务器缓存，根域名服务器缓存，顶级域名服务器缓存，主域名服务器缓存。

**1.先到各种缓存信息中查找**

> **系统缓存**-----如果浏览器中没有找到，浏览器会有一个系统调用，获得系统缓存中的记录

> **路由器缓存**-----接着将请求发给路由器，路由器一般也有自己的DNS缓存

**2.DNS服务器查找**

没有则发送请求到本地域名服务器，每一个本地域名服务器都维护一个高速缓存，存放最近用过的域名及其IP地址.如果还没有则发出递归查询，通过这个IP可以找到客户端到服务器端的唯一路径.

![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/8/19/16ca91c2e5059c3a~tplv-t2oaga2asx-watermark.awebp)

### 3、浏览器主机根据ip地址与服务器建立TCP连接

浏览器向服务器端发送SYN连接请求，经过服务器与浏览器三次报文的交互连接建立完成，就可以发送数据了。

找到了正确的IP地址以后就要开始建立连接了，建立连接的过程一般会使用TCP协议，通过[三次握手](#woshou)建立连接。

### 4、发送HTTP请求

与服务器建立了连接后，就可以向服务器发起请求了

根据HTTP协议的要求，组织一个HTTP数据包，向服务器发送HTTP请求，HTTP的请求报头有请求行和请求报头，空行。

![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/8/19/16ca92442fba516e~tplv-t2oaga2asx-watermark.awebp)

在浏览器中查看报文首部（以QQ浏览器为例）：

![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/8/19/16ca92711d3c352e~tplv-t2oaga2asx-watermark.awebp)

请求行包括请求方法、URI、HTTP版本。首部字段传递重要信息，包括请求首部字段、通用首部字段和实体首部字段。我们可以从报文中看到发出的请求的具体信息。具体每个首部字段的作用，这里不做过多阐述

### 5、服务器处理请求

服务器收到请求并响应，生成一个HTTP响应报文，通过TCP协议发送给浏览器主机

通过HTTP请求服务后，服务器会像浏览器返回一个应答信息----------HTTP响应，

在HTTP里，有请求就会有响应，哪怕是错误信息。这里我们同样看下响应报文的组成结构：

![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/8/19/16ca92a5ebf5c329~tplv-t2oaga2asx-watermark.awebp)

在响应结果中都会有一个[HTTP状态码](#zhuantaima)

### 6、浏览器解析文件

> 浏览器通过解析`HTML`，生成DOM树，解析`CSS`，生成CSS规则树，然后通过DOM树和CSS规则树生成渲染树。渲染树与DOM树不同，渲染树中并没有head、display为none等不必显示的节点。

> `要注意的是`，浏览器的解析过程并非是串连进行的，**比如**在解析CSS的同时，可以继续加载解析HTML，但在解析执行JS脚本时，会停止解析后续HTML，这就会出现阻塞问题，关于JS阻塞相关问题，（js阻塞问题可以自行百度，或者等我有时间更新一篇文章，单独解释阻塞）

浏览器拿到响应文本 HTML 后，接下来介绍下浏览器渲染机制

浏览器解析渲染页面分为一下五个步骤：

- 1. 解析HTML，构建DOM树
  2. 解析CSS，生成CSS规则树
  3. 合并DOM树和CSS规则，生成render树
  4. 布局render树（Layout/reflow），负责各元素尺寸、位置的计算
  5. 绘制render树（paint），绘制页面像素信息

### 7、浏览器布局渲染

根据渲染树布局，计算CSS样式，即每个节点在页面中的大小和位置等几何信息。HTML默认是`流式布局`的，**CSS和js会打破这种布局**，改变DOM的外观样式以及大小和位置。这时就要提到两个重要概念：repaint(重绘)和reflow(回流)。

> *`repaint`：屏幕的一部分重画，不影响整体布局，比如某个CSS的背景色变了，但元素的几何尺寸和位置不变。*

> *`reflow`： 意味着元件的几何尺寸变了，我们需要重新验证并计算渲染树。是渲染树的一部分或全部发生了变化。这就是Reflow，或是Layout。*

所以我们应该尽量减少reflow和repaint,良好的css规范会减少这种操作,[传送门·CSS书写规范和顺序](https://juejin.cn/post/6844903914110713869 "https://juejin.cn/post/6844903914110713869")

最后浏览器绘制各个节点，将页面展示给用户。

致此输入url到展现页面的一个周期就完成了。

### 8、断开TCP连接

为了避免服务器与客户端双方的资源占用和损耗，当双方没有请求或响应传递时，任意一方都可以发起关闭请求。与创建TCP连接的3次握手类似，关闭TCP连接，需要4次握手。

![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/8/19/16ca92cf4bfb6ca1~tplv-t2oaga2asx-watermark.awebp)

- 客户端发起中断请求，发送`FIN`到服务端
- 服务端收到请求，可能数据还没有发完。这个时候不会关闭socket，而是回复`ACK`，告诉客户端知道了
- 客户端进入Fin_Wait状态，继续等待服务端端的`FIN`报文。服务端端发送完毕后，会向客户端发送`FIN`
- 客户端客服端收到后就回复`ACK`，并关闭连接

## 三次握手

![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/2/27/1692e4385f72aae4~tplv-t2oaga2asx-watermark.awebp)

- 客户端发送一个带 SYN=1，Seq=X 的数据包到服务器端口`（第一次握手，由浏览器发起，告诉服务器我要发送请求了）`

- 服务器发回一个带 SYN=1， ACK=X+1， Seq=Y 的响应包以示传达确认信息`（第二次握手，由服务器发起，告诉浏览器我准备接受了，你赶紧发送吧）`

- 客户端再回传一个带 ACK=Y+1， Seq=Z 的数据包，代表“握手结束”`（第三次握手，由浏览器发送，告诉服务器，我马上就发了，准备接受吧）`

## 状态码

![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/8/19/16ca92b2e80b9747~tplv-t2oaga2asx-watermark.awebp)
